<template>
	<div class="content">
		<!-- 
			weex组件文档
			https://weex.apache.org/zh/docs/components/slider.html
		--> 
		
		<!-- 标题栏 -->
		<div class="page-header">
			<!-- 状态栏占位 -->
			<div :style="{ height: statusBarHeight }"></div>
			<div class="page-header-wrapper">
				<div class="page-header-left">
					<!-- <text class="logo">Logo</text> -->
					<text class="logo yticon">&#xe615;</text>
				</div>
				<div class="page-header-center">
					<text class="search-input">输入关键字搜索</text>
				</div>
				<div class="page-header-right">
					<image class="contribute-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAC20lEQVRoQ+1Y7VEVQRDsjkAzUCNQIgAjUCNQIhAjECNQIhAjQCIQMsAIxAwggraa2qXO43bvdu+LenVbxQ/q7e5Nz/TM9CyxI4s7ggMbkMcWyS0iW0Rm8sBGrZkcW33tqIhIeg7gI4BXHRZcATgheV1tXcHBaiCSbPwvAE8z37sB8JqkQc26qoBIsvF/AohbAF2GGugTAI7IHkmDmm0VAwkgHIlIp3ckf7YtDBG7CGCuSO7NhgIolyiSvgP4EIz6RPJbykBJ3uf9XqckD+cCk42IJCfyEQAndXv9IBkBJe2TdAzg80gApq4dcZK6JwlE0lsAZ4mD5yT9+6Al6RTA+0Gb85s6aewjOSDm/RsAvwE0c+CCpLlftELOHPRUudSdPrcPIOnAHBAb68NfSJoeq60GPS9JGtSDtQFZMjxTRcQNrS0z/L9Lb7LJhZxwjsV+48pjjhd3+amApJx/SNLV6L8V9Jd7RyeXATj3fHawBhsLxJ50kndpKRtx1I5Ih/5qypcoWQy8SIONAlKTA5JMm5cADOC43fUlubl+DXcPli2LAmnJkWTjajXaTnp20DWqg/LyWxqRRjSSH4t3Soo9qnevzywdEQVDs0IyGHZPMZK9Cnw0EEn7JC+HREdSBOJBKithJLmieRTA7EAaQm+QRJHkSuRBqnd/w8O3JHMT5p0PR0WkgsdRZF6TfJGLoiSX72cASkeB8mSvAHJPl9wQ1ZL0vTRcPCLhg825w3nixL+TJKFZuofEjj8oGmsBMd8Nxhort849Lg99kFg0R5pWh+boJuY8aK6/oeM/0Gg9OVXfEEtzpMuQQKdYlW5qlO8q1BrSb2r2rEatGmMfNbWmAjQ2IrGUumMXT3VTgQj3+F3Nf8mSnXt88CAUnzwntqvqOs84B6mC0ffSaC/4NTE1tlZZVHHIDvVLY3I87pXQFR9d5cgGZBW3Zz66RWSLyEwe2Kg1k2Orr92ZiPwDeAycQswzKBAAAAAASUVORK5CYII=" />
					<text class="contribute-text">投稿</text>
				</div>
			</div>
		</div>
		
		<uni-tabs @change="tabChange" :index="tabCurrentIndex">
			<!-- uni 官方顶部选项卡组件 -->
			<uni-tab-bar :drag="true" :tab-bars="tabBars" :tab-index="tabCurrentIndex"></uni-tab-bar>
			<uni-tab-content>
			
			<!-- list 垂直滚动列表组件 -->
			<list v-for="(tabItem, tabIndex) in newsitems" @loadmore="loadMore(tabIndex)" loadmoreoffset="10" :key="tabIndex" class="list-content">
				<!-- refresh 下拉刷新组件  
				* 	 weex 的refresh和loading组件在ios效果很好，但是在安卓端效果并不好
				* -->
				<refresh class="loading" @refresh="onRefresh" @pullingdown="onPullingdown" :display="refreshing ? 'show' : 'hide'">
					<loading-indicator v-if="refreshing" class="loading-icon"></loading-indicator>
					<text class="loading-text">{{refreshText}}</text>
				</refresh>
				
				<div class="download-tip" :style="{top: downloadTipTop}">{{ downloadTipalertMsg }}</div>

				<div v-if="tabCurrentIndex === 1" class="everyDayWrapper" @tap.stop.prevent="sharHotspot">
					<div class="everyDay">
						<text class="iconfont icon-dingyue-" />
						<div class="textImg">
							<image mode="aspectFill" class="image" src="../../static/images/everyDay@3x.png" alt="" /></div>
					</div>
				</div>
				
				<!-- 新闻列表 -->
				<cell v-for="(item, index) in tabItem.newsList" :key="item.id" class="news-item" @click="navToDetails(item)">
						<div class="container-wrapper">
							<div v-if="isShowDate(item, index, tabItem.newsList)" class="dateWrapper" @tap.stop.prevent="toReport(item)">
								<div class="LeftDate" :data-text="timeToHumanText(item.created_at)">
									<text class="iconfont icon-rili" />
									<text class="text">{{ timeToHumanText(item.created_at) }}</text>
								</div>
								<div v-if="tabCurrentIndex === 1" class="rightDaily">
									<text class="iconfont icon-fenxiang1" />
									<text>日报</text>
								</div>
							</div>
							<div class="container-list">
								<div v-if="tabCurrentIndex === 0" class="pointLine">
									<text class="splitCircle" />
									<text class="splitLine" />
								</div>
								<div v-if="tabCurrentIndex !== 0" class="pointLine">
									<text class="number">{{ getLiIndex(index, tabIndex) }}.</text>
								</div>
								<div class="content">
									<div class="top-time">
										<text class="time">{{ topTime(item) }}</text>
										<text class="splitCircle" />
										<text class="linkURL">{{ item.domain }}</text>
									</div>
									<div class="middle">
										<div class="left">
											<div class="title font-family-medium text-line-2">{{ item.title }}</div>
											<div class="heatWrapper border-football" @tap.stop.prevent="addHeat(item, index, tabIndex)">
												<div v-if="item.startAnimation" class="addOne">
													<text class="i"/>
													<text>+{{ startAnimationNum }}</text>
												</div>
												<text class="iconfont icon-huo first" />
												<text class="text">{{ item.rate }}</text>
												<text class="iconfont icon-tianjia second" />
											</div>
										</div>
										<div v-if="item.img.length" class="right">
											<div class="articleImg">
												<image class="image" mode="aspectFill" :src="item.img | imageSuffix(96, 70)" :lazy-load="true"/>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
				</cell>
				
				<!-- 加载更多组件 -->
				<cell class="loadmore">
						<text class="loadmore-text">{{tabItem.loadMoreStatus==0?'加载更多...':(tabItem.loadMoreStatus==1?'正在加载..':'加载完成')}}</text>
				</cell>
			</list>
		 
			</uni-tab-content>
		</uni-tabs>
	</div>
</template>

<script>
	import uniTabBar from '@/components/tab-nvue/tabbar.nvue'
	import uniTabContent from '@/components/tab-nvue/tabContent.nvue'
	import uniTabs from '@/components/tab-nvue/tabs.nvue'
	import nvueLib from '@/lib/nvue.js'
	import { urlencode } from '@/lib/string'
	import { timeToHumanText, getTimestampByDateStr } from '@/lib/time'
	const domModule = weex.requireModule('dom')

	export default { 
		components: {
			uniTabContent,
			uniTabBar,
			uniTabs
		},
		data(){
			return {
				tabBars: [],
				newsitems: [],
				tabCurrentIndex: 1,
				refreshing: false,
				refreshText: "下拉刷新数据",
				regions: [],
				liIndexConfig: [],
				downloadTipTop: '-200upx',
				downloadTipalertMsg: '',
				statusBarHeight: '0wx', //状态栏占位高度
			}
		},
		beforeCreate(){
			const domModule = weex.requireModule('dom')
			domModule.addRule('fontFace', {
			    'fontFamily': "yticon",
			    'src': "url('https://at.alicdn.com/t/font_1078604_3mrhac2o3oi.ttf')",
			});
		},
		created() {
			//获取状态栏高度给顶部占位节点
			uni.getSystemInfo({
				success: res=>{
					this.statusBarHeight = res.statusBarHeight + 'wx';
				}
			})
			//获取数据，方法通过mixin混入
			this.loadTabbars();
		},
		methods: {
			getHomeData(successCallback) {
				nvueLib.postRequest('home').then(res=>{
					var code = res.code
					if (code !== 1000) {
						// window.mui.toast(res.message)
						return
					}
					successCallback(res.data)
				})
			},
			getListData(pageNum, typeValue, successCallback) {
				nvueLib.postRequest(`readList`, {page: pageNum, tagFilter: typeValue}, false).then(res => {
					var code = res.code
					if (code !== 1000) {
						// window.mui.toast(res.message)
						return
					}
					successCallback(res.data)
				})
			},
			async tabChange(e) {
				console.log(e.index)
				this.tabCurrentIndex = e.index;
				//第一次切换tab，动画结束后需要加载数据
				let tabItem = this.newsitems[this.tabCurrentIndex];
				if(this.tabCurrentIndex !== 1 && tabItem.loaded !== true){
					this.loadNewsList('refresh', this.tabCurrentIndex);
					tabItem.loaded = true;
				}
			},
			showDownloadTip() {
				this.downloadTipTop = '0upx'
			},
			hideDownloadTip() {
				this.downloadTipTop = '-200upx'
			},
			getElSize(el) { //得到元素的size
				return new Promise((res, rej) => {
					const result = dom.getComponentRect(el, option => {
						res(option.size);
					})
				})
			},
			//加载更多
			loadMore(e){
				this.loadNewsList('add',e);
			},
			//下拉刷新
			onRefresh(event) {
				console.log('onrefresh')
				this.refreshText = "正在加载...";
				this.loadNewsList('refresh',this.tabCurrentIndex)
			},
			onPullingdown(event) {
				console.log('onpullingdown')
				if (this.refreshing) {
					return;
				}
				if (Math.abs(event.pullingDistance) > Math.abs(event.viewHeight)) {
					this.refreshText = "释放立即刷新";
				} else {
					this.refreshText = "下拉可以刷新";
				}
			},
			loadTabbars(){
				this.getHomeData((data) => {
					data.regions.unshift({ value: '', text: '全部' })
					let tabList = data.regions;
					tabList.forEach(item=>{
						item.name = item.text
						item.id = item.value
					})
					this.tabBars = tabList;
					
					let ary = [];
					for (let i = 0, length = this.tabBars.length; i < length; i++) {
						let aryItem = {
							page: 1,
							value: this.tabBars[i].value,
							id: this.tabBars[i].value,
							loadMoreStatus: 0, // 加载更多 0加载前，1加载中，2没有更多了
							loadingText: "加载更多...",
							newsList: []
						};
						
						ary.push(aryItem);
					}
					this.newsitems = ary;
					this.loadNewsList('refresh',this.tabCurrentIndex);
				})
			},
			//新闻列表
			loadNewsList(type, index){
				let tabItem = this.newsitems[index];
				console.log(index)
				
				//type add 加载更多 refresh下拉刷新
				if(type === 'add'){
					if(tabItem.loadMoreStatus === 2){
						tabItem.loadMoreStatus = 1
						setTimeout(() => {
							tabItem.loadMoreStatus = 2;
						}, 100)
						return;
					}
					tabItem.loadMoreStatus = 1;
				} else if(type === 'refresh'){
					this.refreshing = true
					tabItem.page = 1
				}
				
				//异步请求数据
				this.getListData(tabItem.page, tabItem.value, (res) => {
					tabItem.page += 1
					var list = res.data
					if(type === 'refresh'){
						this.refreshing = false
						console.log(this.refreshing)
						tabItem.newsList = list
						tabItem.page = 1
					} else {
						tabItem.newsList = tabItem.newsList.concat(list)
					}

					if (type === 'refresh') {						
						this.refreshing = false

						if (tabItem.page === 1) {
							if (res.alert_msg) {
								this.downloadTipalertMsg = res.alert_msg
								this.showDownloadTip()
							}
							setTimeout(() => {
								this.hideDownloadTip()
							}, 2000)
						}
					}

					tabItem.loadMoreStatus = res.next_page_url ? 0 : 2
				})
			},
			//新闻详情
			navToDetails(item){
				const data = {
					id: item.id,
					title: item.title,
					url: item.link_url,
					img: item.img
				}

				uni.navigateTo({
					url: `/pages/webview/article?data=${urlencode(JSON.stringify(data))}`
				})
			},
			scrollList(e) {
				const views = uni.createSelectorQuery().selectAll('.LeftDate')
				views.boundingClientRect(data => {
					data.forEach((item, index) => {
						if (item.top <= 100) {
							this.position = item.dataset.text
						}
					})
					// console.log('得到节点信息' + JSON.stringify(data))
				}).exec()
			},
			sharHotspot() {
				this.$refs.HotBottomActions.show()
			},
			getLiIndex(itemIndex, listDataIndex) {
				if (!this.liIndexConfig[listDataIndex]) {
					this.liIndexConfig[listDataIndex] = 1
				} else {
					this.liIndexConfig[listDataIndex]++
				}

				if (!this.isShowSplitLine(itemIndex - 1, listDataIndex)) {
					this.liIndexConfig[listDataIndex] = 1
				}

				return this.liIndexConfig[listDataIndex]
			},
			startAnimationEvent(num) {
				this.startAnimationNum = num
				var item = this.newsitems[this.activeListIndex].newsList[this.activeItemIndex]

				item.startAnimation = 1
				item.rate += num
				Vue.set(this.newsitems[this.activeListIndex].newsList, this.activeItemIndex, item)

				setTimeout(() => {
					item.startAnimation = 0
					Vue.set(this.newsitems[this.activeListIndex].newsList, this.activeItemIndex, item)
				}, 2500)
			},
			isShowSplitLine(itemIndex, listDataIndex) {
				if (itemIndex >= this.newsitems[listDataIndex].newsList.length - 1) {
					return false
				}

				var nextItemIndex = itemIndex + 1
				var isNextDate = this.isShowDate(this.newsitems[listDataIndex].newsList[nextItemIndex], nextItemIndex, this.newsitems[listDataIndex].newsList)
				if (isNextDate) {
					return false
				}

				return true
			},
			showItemMore(item) {
				item.feed_type = 16
				item.user = {
					id: 0
				}
				item.feed = {
					is_bookmark: item.is_upvoted,
					submission_id: item.id
				}
				this.shareIconMenus = [] // getIconMenus(item)
				this.itemOptionsObj = item
				this.shareOption = getHomeDetail(
					'/c/' + item.category_id + '/' + item.slug, // item.link_url,
					item.title,
					item.img
				)
				this.shareOption.targetId = item.slug
				this.shareOption.targetType = 'submission'
				this.$refs.share.share()
			},
			addHeat(item, itemIndex, listIndex) {
				this.activeItem = item
				this.activeItemIndex = itemIndex
				this.activeListIndex = listIndex
				this.$refs.BottomActions.show()
			},

			isShowDate(item, index, list) {
				const itemTime = item.created_at.split(' ')[0]
				const currentData = timeToHumanText(getTimestampByDateStr(itemTime))

				const prevItem = list[index - 1]
				if (!prevItem) return true

				const prevData = timeToHumanText(getTimestampByDateStr(prevItem.created_at.split(' ')[0]))
				return currentData !== prevData
			},
			toSearch() {
				uni.navigateTo({ url: '/pages/search/index' })
			},
			toReport(item) {
				uni.navigateTo({ url: '/pages/report/daily?date=' + item.created_at.split(' ')[0] })
			},
			toRoute(url) {
				uni.navigateTo({ url: url })
			},
			topTime(item) {
				return item.created_at.split(' ')[1].substring(0, 5)
			},
			timeToHumanText(time) {
				return timeToHumanText(getTimestampByDateStr(time))
			}
		}
	}
</script>

<style>
	
	
	/* 字体图标 */
	.yticon {
		font-family: yticon;
	}
	/**
	 * weex css限制
	 * 选择器不支持嵌套
	 * 子节点不继承父节点样式（重要）
	 * 仅支持 flex布局 （这个还不错）， 默认为display:flex; flex-direction:column;
	 * 
	 * 注：我对weex也是一知半解，有说错的麻烦指出
	 */
	.tab-bar-item {
		width: 150px;
		height: 100px;
		flex-direction: column;
		align-items: center;
		justify-content: center;
	}

	.tab-bar-title {
		height: 100px;
		line-height: 100px;
		font-size: 30px;
		color: #555;
	}

	.active {
		color: #007AFF;
	}

	.loadmore {
		height: 70px;
		width: 750px;
		flex-direction: column;
		justify-content: center;
	}

	.loadmore-text {
		font-size: 30px;
		text-align: center;
		color: #999999;
	}

	.refresh {
		width: 750px;
		height: 70px;
		flex-direction: row;
		align-items: center;
		justify-content: center;
	}

	.refresh-text {
		text-align: center;
		font-size: 28px;
		color: #999999;
	}
	.content{
		flex: 1;
		background-color: #fff;
	}
	/* 顶部标题栏 */
	.page-header{
		background-color: #ec706b;
	}
	.page-header-wrapper{
		flex-direction: row;
		justify-content: center;
		align-items: center;
		height: 100px;
		padding: 0px 20px;
	}
	.page-header-left{
		opacity: 0.9;
	}
	.logo{
		font-size: 40px;
		color: #fff;
	}
	.page-header-center{
		flex: 1;
		padding: 0px 30px 0 20px;
	}
	.search-input{
		height: 60px;
		font-size:28px;
		color: #fff;
		text-align: center;
		line-height: 60px;
		background-color: rgba(255,255,255,.2);
		border-radius: 100px;
	}
	.page-header-right{
		width: 50px;
		align-items: center;
	}
	.contribute-icon{
		width: 50px;
		height: 44px;
	}
	.contribute-text{
		font-size: 20px;
		color: #fff;
	}
	
	
	.slider{
		flex: 1;
		background-color: #f8f8f8;
	}
	.list-content{
		flex: 1;
		background-color: #fff;
	}
	/* 下拉刷新 加载更多 */
	.loading {
		flex-direction: row;
		align-items: center;
		justify-content: center;
		width: 750px;
		height: 80px;
	}
	.loading-text{
		font-size: 28px;
		color: #888;
	}
	.loading-icon{
		height: 40px;
		width: 40px;
		color: #999999;
		margin-right: 10px;
	}

	/* 新闻列表  */
	.news-item{
		width: 750px;
		padding: 24px 30px;
		border-bottom-width: 1px;
		border-color: #eee;
		background-color: #fff;
	}
	
	.splitCircle {
    display: inline-block;
    position: relative;
    top: -2px;
    border-radius: 50%;
    width: 2px;
    height: 2px;
    background: #B4B4B6;
  }
	
	
</style>
